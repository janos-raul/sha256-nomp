<style>
    /* Miner Stats Page Specific Styles */
    .miner-stats-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem 1.5rem;
    }

    /* Chart Section */
    .chart-wrapper {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 1rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
    }

    .chart-wrapper::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 3px;
        background: var(--gradient);
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border);
    }

    .miner-address {
        font-size: 1.4rem;
        font-weight: 600;
        color: var(--text-primary);
        word-break: break-all;
    }

    .chart-stats {
        display: flex;
        gap: 2rem;
        flex-wrap: wrap;
    }

    .chart-stat {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: var(--bg-secondary);
        border-radius: 0.5rem;
        font-size: 0.9rem;
    }

    .chart-stat i {
        color: var(--accent);
    }

    .chart-stat span {
        color: var(--text-secondary);
    }

    .chart-stat strong {
        color: var(--text-primary);
        margin-left: 0.25rem;
        font-family: 'Courier New', monospace;
    }

    .chart-holder {
        position: relative;
        height: 300px;
        margin: 1.5rem 0;
    }

    /* Balance Section */
    .balance-section {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 1rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
    }

    .balance-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 1rem;
        background: var(--bg-secondary);
        border-radius: 0.75rem;
        transition: all 0.3s ease;
    }

    .balance-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(59, 130, 246, 0.2);
    }

    .balance-icon {
        width: 40px;
        height: 40px;
        background: rgba(59, 130, 246, 0.1);
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 0.5rem;
        color: var(--accent);
        font-size: 1.2rem;
    }

    .balance-label {
        font-size: 0.9rem;
        color: var(--text-muted);
        margin-bottom: 0.25rem;
    }

    .balance-value {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--text-primary);
        font-family: 'Courier New', monospace;
    }

    /* Workers Grid */
    .workers-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .worker-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 1rem;
        padding: 1.5rem;
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .worker-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(59, 130, 246, 0.2);
        border-color: var(--accent);
    }

    .worker-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 3px;
    }

    .worker-card.pool::before {
        background: var(--success);
    }

    .worker-card.solo::before {
        background: var(--warning);
    }

    .worker-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid var(--border);
    }

    .worker-name {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-primary);
    }

    .worker-badge {
        display: inline-block;
        padding: 0.25rem 0.6rem;
        border-radius: 0.4rem;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .badge-pool {
        background: rgba(16, 185, 129, 0.2);
        color: var(--success);
    }

    .badge-solo {
        background: rgba(245, 158, 11, 0.2);
        color: var(--warning);
    }

    .worker-stats {
        display: grid;
        gap: 0.75rem;
    }

    .worker-stat {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.9rem;
    }

    .worker-stat-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--text-secondary);
    }

    .worker-stat-label i {
        width: 20px;
        text-align: center;
        color: var(--text-muted);
    }

    .worker-stat-value {
        color: var(--text-primary);
        font-weight: 500;
        font-family: 'Courier New', monospace;
    }

    /* Section Headers */
    .section-divider {
        display: flex;
        align-items: center;
        margin: 2rem 0;
    }

    .section-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 0.75rem;
        background: var(--bg-primary);
        padding-right: 1rem;
    }

    .section-line {
        flex: 1;
        height: 2px;
        background: var(--border);
    }

    /* Empty State */
    .no-workers {
        text-align: center;
        padding: 3rem;
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 1rem;
        color: var(--text-secondary);
    }

    .no-workers i {
        font-size: 3rem;
        color: var(--text-muted);
        margin-bottom: 1rem;
        display: block;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .chart-header {
            flex-direction: column;
            align-items: flex-start;
        }

        .miner-address {
            font-size: 1.2rem;
        }

        .chart-stats {
            flex-direction: column;
            gap: 0.5rem;
            width: 100%;
        }

        .chart-stat {
            width: 100%;
            justify-content: space-between;
        }

        .balance-section {
            grid-template-columns: 1fr;
        }

        .workers-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<div class="miner-stats-container">
    <!-- Hashrate Chart -->
    <div class="chart-wrapper">
        <div class="chart-header">
            <div class="miner-address">
                <i class="fas fa-wallet"></i> {{=String(it.stats.address).split(".")[0]}}
            </div>
            <div class="chart-stats">
                <div class="chart-stat">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Now:</span>
                    <strong id="statsHashrate">...</strong>
                </div>
                <div class="chart-stat">
                    <i class="fas fa-gauge"></i>
                    <span>Avg:</span>
                    <strong id="statsHashrateAvg">...</strong>
                </div>
                <div class="chart-stat">
                    <i class="fas fa-clock"></i>
                    <span>Luck:</span>
                    <strong id="statsLuckDays">...</strong>
                </div>
            </div>
        </div>
        <div class="chart-holder">
            <canvas id="workerHashrateChart"></canvas>
        </div>
    </div>

    <!-- Balance Section -->
    <div class="balance-section">
        <div class="balance-item">
            <div class="balance-icon">
                <i class="fas fa-hourglass-half"></i>
            </div>
            <div class="balance-label">Immature</div>
            <div class="balance-value" id="statsTotalImmature">...</div>
        </div>
        <div class="balance-item">
            <div class="balance-icon">
                <i class="fas fa-wallet"></i>
            </div>
            <div class="balance-label">Balance</div>
            <div class="balance-value" id="statsTotalBal">...</div>
        </div>
        <div class="balance-item">
            <div class="balance-icon">
                <i class="fas fa-money-bill-wave"></i>
            </div>
            <div class="balance-label">Total Paid</div>
            <div class="balance-value" id="statsTotalPaid">...</div>
        </div>
        <div class="balance-item">
            <div class="balance-icon">
                <i class="fas fa-chart-bar"></i>
            </div>
            <div class="balance-label">Total Shares</div>
            <div class="balance-value" id="statsTotalShares">...</div>
        </div>
    </div>

    <!-- Pool Workers Section -->
    <div id="poolWorkersSection" class="workers-section" style="display:none;">
        <div class="section-divider">
            <h3 class="section-title">
                <i class="fas fa-server"></i> Pool Workers
            </h3>
            <div class="section-line"></div>
        </div>
        <div id="boxesPoolWorkers" class="workers-grid"></div>
    </div>

    <!-- Solo Workers Section -->
    <div id="soloWorkersSection" class="workers-section" style="display:none;">
        <div class="section-divider">
            <h3 class="section-title">
                <i class="fas fa-user"></i> Solo Workers
            </h3>
            <div class="section-line"></div>
        </div>
        <div id="boxesSoloWorkers" class="workers-grid"></div>
    </div>
</div>

<script>
    var _miner = "{{=String(it.stats.address || '').split('.')[0]}}";
    var _workerCount = 0;
    
    // Make functions available globally
    window.getWorkerNameFromAddress = function(w) {
        var worker = w;
        // Check if there's a dot in the address (indicating a worker name)
        if (w.indexOf(".") > -1) {
            var parts = w.split(".");
            // Get everything after the first dot as the worker name
            worker = parts.slice(1).join(".");
            // If worker name is empty or just whitespace, use "noname"
            if (!worker || worker.trim().length === 0) {
                worker = "noname";
            }
        } else {
            // No dot found, so no worker name provided
            worker = "noname";
        }
        return worker;
    };
    
    // Modern worker display function
    function addWorkerToDisplay(name, htmlSafeName, workerObj, isSolo) {
        var htmlToAdd = '';
        var cardClass = isSolo ? 'solo' : 'pool';
        var badgeClass = isSolo ? 'badge-solo' : 'badge-pool';
        var badgeText = isSolo ? 'SOLO' : 'POOL';
        
        // Ensure we display "noname" if no worker name is provided
        var displayName = name;
        if (!displayName || displayName.trim().length === 0) {
            displayName = "noname";
        }
        
        htmlToAdd = '<div class="worker-card ' + cardClass + '" id="worker_' + htmlSafeName + '">';
        htmlToAdd += '<div class="worker-header">';
        htmlToAdd += '<div class="worker-name">' + displayName.replace(/[^\w\s]/gi, '') + '</div>';
        htmlToAdd += '<span class="worker-badge ' + badgeClass + '">' + badgeText + '</span>';
        htmlToAdd += '</div>';
        htmlToAdd += '<div class="worker-stats">';
        
        // Hashrate Now
        htmlToAdd += '<div class="worker-stat">';
        htmlToAdd += '<span class="worker-stat-label"><i class="fas fa-tachometer-alt"></i> Hashrate</span>';
        htmlToAdd += '<span class="worker-stat-value" id="statsHashrate' + htmlSafeName + '">...</span>';
        htmlToAdd += '</div>';
        
        // Hashrate Avg
        htmlToAdd += '<div class="worker-stat">';
        htmlToAdd += '<span class="worker-stat-label"><i class="fas fa-gauge"></i> Average</span>';
        htmlToAdd += '<span class="worker-stat-value" id="statsHashrateAvg' + htmlSafeName + '">...</span>';
        htmlToAdd += '</div>';
        
        // Difficulty
        htmlToAdd += '<div class="worker-stat">';
        htmlToAdd += '<span class="worker-stat-label"><i class="fas fa-unlock-alt"></i> Difficulty</span>';
        htmlToAdd += '<span class="worker-stat-value" id="statsDiff' + htmlSafeName + '">...</span>';
        htmlToAdd += '</div>';
        
        // Shares
        htmlToAdd += '<div class="worker-stat">';
        htmlToAdd += '<span class="worker-stat-label"><i class="fas fa-cog"></i> Shares</span>';
        htmlToAdd += '<span class="worker-stat-value" id="statsShares' + htmlSafeName + '">...</span>';
        htmlToAdd += '</div>';
        
        // Luck
        htmlToAdd += '<div class="worker-stat">';
        htmlToAdd += '<span class="worker-stat-label"><i class="fas fa-clock"></i> Luck</span>';
        htmlToAdd += '<span class="worker-stat-value" id="statsLuckDays' + htmlSafeName + '">...</span>';
        htmlToAdd += '</div>';
        
        // Balance
        htmlToAdd += '<div class="worker-stat">';
        htmlToAdd += '<span class="worker-stat-label"><i class="fas fa-wallet"></i> Balance</span>';
        htmlToAdd += '<span class="worker-stat-value" id="statsBalance' + htmlSafeName + '">...</span>';
        htmlToAdd += '</div>';
        
        // Paid
        htmlToAdd += '<div class="worker-stat">';
        htmlToAdd += '<span class="worker-stat-label"><i class="fas fa-money-bill"></i> Paid</span>';
        htmlToAdd += '<span class="worker-stat-value" id="statsPaid' + htmlSafeName + '">...</span>';
        htmlToAdd += '</div>';
        
        htmlToAdd += '</div></div>';
        
        var targetContainer = isSolo ? "#boxesSoloWorkers" : "#boxesPoolWorkers";
        var targetSection = isSolo ? "#soloWorkersSection" : "#poolWorkersSection";
        
        $(targetSection).show();
        $(targetContainer).append(htmlToAdd);
    }
    
    function rebuildWorkerDisplay() {
        $("#boxesPoolWorkers").html("");
        $("#boxesSoloWorkers").html("");
        $("#poolWorkersSection").hide();
        $("#soloWorkersSection").hide();
        
        if (window.statData && window.statData.workers) {
            for (var w in window.statData.workers) {
                var worker = window.statData.workers[w];
                var isSolo = worker.isSolo === true;
                var htmlSafeWorkerName = (isSolo ? 'solo_' : '') + w.split('.').join('_').replace(/[^\w\s]/gi, '');
                var saneWorkerName = getWorkerNameFromAddress(w);
                addWorkerToDisplay(saneWorkerName, htmlSafeWorkerName, worker, isSolo);
            }
        }
    }
    
    // Make functions globally available
    window.rebuildWorkerDisplay = rebuildWorkerDisplay;
    window.addWorkerToDisplay = addWorkerToDisplay;
    
    // Initialize - prevent double loading
    $(document).ready(function() {
        console.log('Initializing miner stats for:', _miner);

        // Check if script is already loaded to prevent double loading
        if (!window.minerStatsScriptLoaded) {
            window.minerStatsScriptLoaded = true;

            // Load the modernized miner_stats.js directly
            // EventSource is already handled by main.js globally
            var script = document.createElement('script');
            script.src = '/static/modern-miner-stats.js?v=' + Date.now();
            script.onload = function() {
                console.log('Miner stats script loaded successfully');
            };
            document.querySelector('main').appendChild(script);
        }
    });
</script>